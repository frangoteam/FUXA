name: Build FUXA Electron App (Latest)

on:
  #push:
    #branches:
  #pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [x64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew update
        brew install cairo pango pkg-config

    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev pkg-config

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install cairo --version=1.17.2.1
        choco install pkgconfiglite

    - name: Configure npm for reliable CI builds
      run: |
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retries 8
        npm config set fetch-retry-factor 2
        npm config set fetch-retry-mintimeout 30000
        npm config set fetch-retry-maxtimeout 300000
        npm config set audit false
        npm config set fund false
      env:
        NODE_OPTIONS: --max-old-space-size=4096 --dns-result-order=ipv4first

    - name: Clear npm cache
      run: npm cache clean --force

    - name: Install server dependencies
      run: npm install && npm run build:all
      working-directory: ./server
      env:
        NODE_OPTIONS: --max-old-space-size=4096 --dns-result-order=ipv4first

    - name: Install client dependencies
      run: npm install
      working-directory: ./client
      env:
        NODE_OPTIONS: --max-old-space-size=4096 --dns-result-order=ipv4first

    - name: Build client
      run: npm run build -- --configuration=production
      working-directory: ./client
      env:
        NODE_OPTIONS: --max-old-space-size=4096 --dns-result-order=ipv4first

    - name: Install app dependencies
      run: npm install
      working-directory: ./app/electron
      env:
        NODE_OPTIONS: --max-old-space-size=4096 --dns-result-order=ipv4first

    - name: Copy server and client build to app/electron
      run: |
        mkdir -p app/electron/server
        mkdir -p app/electron/client/dist
        cp -r server/. app/electron/server/
        cp -r client/dist/. app/electron/client/dist
      shell: bash

    - name: Package for Windows
      if: matrix.os == 'windows-latest' && matrix.arch == 'x64'
      run: npx electron-builder --win nsis --x64
      working-directory: ./app/electron

    - name: Package for Linux
      if: matrix.os == 'ubuntu-latest'
      run: npx electron-builder --linux appimage --${{ matrix.arch }}
      working-directory: ./app/electron

    - name: Package for macOS
      if: matrix.os == 'macos-latest'
      run: npx electron-builder --mac dmg --${{ matrix.arch }}
      working-directory: ./app/electron

    - name: Prepare artifacts
      run: |
        mkdir -p artifacts
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          mv dist/*.exe artifacts/FUXA-windows-x64.exe
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ "${{ matrix.arch }}" = "x64" ]; then
          mv dist/*.AppImage artifacts/FUXA-linux-x64.AppImage
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
          mv dist/*.AppImage artifacts/FUXA-linux-arm64.AppImage
        elif [ "${{ matrix.os }}" = "macos-latest" ] && [ "${{ matrix.arch }}" = "x64" ]; then
          mv dist/*.dmg artifacts/FUXA-macos-x64.dmg
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          mv dist/*.dmg artifacts/FUXA-macos-arm64.dmg
        fi
      working-directory: ./app/electron
      shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: FUXA-${{ matrix.os }}-${{ matrix.arch }}
        path: app/electron/artifacts/*
